<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel 10 Pro Fold & Watch 4 Quiz</title>
    <!-- Lade Tailwind CSS f√ºr das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Angepasste Schriftart und Hintergrund */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            position: relative; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* Hintergrundbild direkt auf Body setzen */
            background-image: url('https://i.postimg.cc/kGsKH6sP/Bildschirmfoto-2025-10-06-um-09-38-23.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: scroll; /* Muss 'scroll' sein, nicht 'fixed' f√ºr iFrames */
        }
        
        /* Overlay f√ºr helleren Hintergrund mit Transparenz */
        body::before {
            content: "";
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            min-height: 100vh;
            background-color: rgba(255, 255, 255, 0.4); /* Wei√ü-Overlay f√ºr mehr Lesbarkeit (40% Transparenz) */
            z-index: -1;
        }

        .container-card {
            max-width: 600px;
            margin: 1rem auto; 
            /* Leichte Transparenz f√ºr die Quiz-Karte */
            background: rgba(255, 255, 255, 0.95); /* Leicht erh√∂hte Deckkraft */
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        }
        /* Kontrastreiche Header-Farben (Schwarz) */
        header h1, header p {
             color: #1f2937; /* Schwarz/Dunkelgrau f√ºr Lesbarkeit auf hellem Overlay */
             text-shadow: 0 0px 4px rgba(255, 255, 255, 0.6); /* Leichter Schatten */
        }
        /* Alle Texte innerhalb der wei√üen Box sind wieder dunkel, um auf wei√üem Grund lesbar zu sein */
        .container-card h2, .container-card p, .container-card label {
            color: #1f2937;
        }

        /* Styling f√ºr das Kalender-Modal (Pop-up) */
        .modal {
            display: none; /* Standardm√§√üig versteckt */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% von oben und zentriert */
            padding: 20px;
            border-radius: 1rem;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        /* Styling f√ºr Scrollbar bei Terminen (nur f√ºr Web-Vorschau) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Zus√§tzliches Styling f√ºr den 3D-Effekt im Kalender */
        .calendar-button-3d {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Standard Schatten */
        }

        .calendar-button-3d:hover {
            transform: translateY(-2px) translateZ(5px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); /* Schatten beim Hover */
        }

        .calendar-button-3d:active {
            transform: translateY(0) translateZ(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.08); /* Schatten beim Klicken */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'google-blue': '#4285F4',
                        'google-green': '#34A853',
                        'google-yellow': '#FBBC05',
                        'google-red': '#EA4335',
                        'pixel-gray': '#e8eaed',
                    }
                }
            }
        }
    </script>
</head>
<body>

<!-- pt-48 (192px) f√ºr gro√üen Abstand oben. -->
<div id="app" class="p-4 sm:p-8 pt-48 pb-10"> 
    <header class="text-center mb-10">
        <!-- √úberschrift: It's Quiz Time -->
        <h1 class="text-3xl sm:text-4xl font-extrabold flex items-center justify-center">
            <span class="mr-2">üöÄ</span>
            It¬¥s Quiz Time üöÄ
        </h1>
        <p class="text-xl font-semibold mt-2">Teste Dein Wissen zu Pixel 10 Pro Fold & Watch 4!</p>
    </header>

    <div id="quiz-container" class="container-card">
        <!-- Inhalte werden per JavaScript eingef√ºgt -->
        <div class="text-center py-10">
            <p class="mt-4 text-gray-600">Initialisierung des Quiz...</p>
        </div>
    </div>
</div>

<!-- Interaktives Kalender Modal (Pop-up) -->
<div id="calendar-popover" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-modal-top">&times;</span>
        <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
            <i data-lucide="calendar-check" class="w-5 h-5 mr-2 text-google-blue"></i> Termin speichern
        </h3>
        <p class="mb-4 text-gray-600">W√§hle, wo Du **<span id="event-date-display"></span> um <span id="event-time-display"></span>** speichern m√∂chtest:</p>
        <div class="space-y-3" id="calendar-options">
            <!-- Dynamische Links hier eingef√ºgt -->
        </div>
        <button id="close-modal-btn" class="w-full mt-4 bg-pixel-gray text-gray-800 p-3 rounded-lg font-semibold hover:bg-pixel-gray/70 transition duration-150">
            Schlie√üen & zum Quiz
        </button>
    </div>
</div>

<script>
    // --- Globale Kalender-Funktionen, die vom HTML-onclick ben√∂tigt werden ---
    
    /**
     * Helper: Formatiert Datum und Zeit in das ISO-√§hnliche Format (YYYYMMDDTHHMMSS) f√ºr Kalender.
     * Das 'Z' (UTC) wird bewusst weggelassen, damit die Zeit als "lokal" f√ºr die angegebene Zeitzone (ctz) interpretiert wird.
     */
    function formatDateForCalendar(dateStr, timeStr) {
        // dd.mm.yyyy -> [dd, mm, yyyy]
        const [day, month, year] = dateStr.split('.').map(s => s.padStart(2, '0'));
        // hh:mm -> hhmm (entfernt " Uhr" und Leerzeichen)
        const timeCleaned = timeStr.replace(' Uhr', '').replace(/\s/g, ''); 
        const time = timeCleaned.replace(':', ''); 
        return `${year}${month}${day}T${time}00`; // Korrektur: 'Z' entfernt
    }

    /**
     * Helper: Generiert den Google Kalender Link mit korrekter Zeitzone.
     */
    function generateGCalLink(event) {
        const title = encodeURIComponent("Pixel Fold & Watch Training");
        const startDate = formatDateForCalendar(event.date, event.time);
        
        // Korrektur: Robuste Berechnung der Endzeit (30 Minuten sp√§ter)
        const [day, month, year] = event.date.split('.').map(Number);
        const [hour, minute] = event.time.replace(' Uhr', '').split(':').map(Number);
        
        // Monat ist 0-basiert in JavaScript (Januar = 0), daher month - 1
        const startDateObj = new Date(year, month - 1, day, hour, minute);
        const endDateObj = new Date(startDateObj.getTime() + 30 * 60000); // 30 Minuten in Millisekunden addieren

        // End-Datum und -Zeit aus dem neuen Datumsobjekt extrahieren
        const endDay = endDateObj.getDate().toString().padStart(2, '0');
        const endMonth = (endDateObj.getMonth() + 1).toString().padStart(2, '0');
        const endYear = endDateObj.getFullYear();
        const endHour = endDateObj.getHours().toString().padStart(2, '0');
        const endMinute = endDateObj.getMinutes().toString().padStart(2, '0');

        const formattedEndDate = formatDateForCalendar(`${endDay}.${endMonth}.${endYear}`, `${endHour}:${endMinute}`);
        
        const details = encodeURIComponent("Webinar zu den neuen Features des Google Pixel 10 Pro Fold und der Pixel Watch 4.\nMeeting Link: https://" + event.link);
        const location = encodeURIComponent("Online Meeting: https://" + event.link);
        const timezone = "Europe/Berlin"; // Korrektur: Zeitzone hinzugef√ºgt

        // Korrektur: Der URL wird der Parameter 'ctz' (calendar timezone) hinzugef√ºgt
        return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${formattedEndDate}&details=${details}&location=${location}&ctz=${timezone}&sf=true&output=xml`;
    }

    /**
     * Helper: Erzeugt und l√§dt eine .ics Datei herunter (f√ºr Outlook, Apple Kalender etc.).
     */
    function downloadIcs(event) {
        const title = "Pixel Fold & Watch Training";
        const startDate = formatDateForCalendar(event.date, event.time);
        
        // Korrektur: Robuste Berechnung der Endzeit (identisch zu oben)
        const [day, month, year] = event.date.split('.').map(Number);
        const [hour, minute] = event.time.replace(' Uhr', '').split(':').map(Number);
        const startDateObj = new Date(year, month - 1, day, hour, minute);
        const endDateObj = new Date(startDateObj.getTime() + 30 * 60000); 

        const endDay = endDateObj.getDate().toString().padStart(2, '0');
        const endMonth = (endDateObj.getMonth() + 1).toString().padStart(2, '0');
        const endYear = endDateObj.getFullYear();
        const endHour = endDateObj.getHours().toString().padStart(2, '0');
        const endMinute = endDateObj.getMinutes().toString().padStart(2, '0');
        const formattedEndDate = formatDateForCalendar(`${endDay}.${endMonth}.${endYear}`, `${endHour}:${endMinute}`);

        const description = "Webinar zu den neuen Features des Google Pixel 10 Pro Fold und der Pixel Watch 4. Meeting Link: https://" + event.link;
        const location = "Online Meeting: https://" + event.link;

        // Korrektur: Zeilenumbr√ºche in der Beschreibung f√ºr .ics-Dateien korrekt formatieren
        const icsDescription = description.replace(/\n/g, '\\n');
        
        const icsContent = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//Google Inc//Google Calendar 70.6265//EN',
            'CALSCALE:GREGORIAN',
            'BEGIN:VEVENT',
            'DTSTART:' + startDate,
            'DTEND:' + formattedEndDate,
            'SUMMARY:' + title,
            'DESCRIPTION:' + icsDescription,
            'LOCATION:' + location,
            'UID:' + crypto.randomUUID(),
            'END:VEVENT',
            'END:VCALENDAR'
        ].join('\r\n'); // Korrektur: Standardkonforme Zeilenenden f√ºr .ics

        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Training_${event.date.replace(/\./g, '')}_${event.time.replace(':', '').replace(' Uhr', '')}.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    /**
     * √ñffnet das Modal und f√ºllt es mit den Kalenderoptionen und speichert das Event, um zum Quiz zu wechseln.
     */
    function openCalendarModal(event) {
        // 1. Event speichern und zum Quiz wechseln
        if (typeof window.quizApp === 'object' && typeof window.quizApp.selectEventAndProceed === 'function') {
            window.quizApp.selectEventAndProceed(event);
        } else {
            console.error("Quiz App State nicht initialisiert. Kann Event nicht speichern und fortfahren.");
        }

        // 2. Modal-Inhalt f√ºllen und anzeigen
        const modal = document.getElementById('calendar-popover');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const closeModalTop = document.getElementById('close-modal-top');

        document.getElementById('event-date-display').textContent = event.date;
        document.getElementById('event-time-display').textContent = event.time; // Zeigt die exakte Zeit aus dem Event an

        const optionsContainer = document.getElementById('calendar-options');
        optionsContainer.innerHTML = `
            <a href="${generateGCalLink(event)}" target="_blank" class="flex items-center justify-center p-3 font-semibold rounded-lg bg-google-blue text-white hover:bg-opacity-90 transition duration-150">
                <i data-lucide="calendar-plus" class="w-5 h-5 mr-2"></i> Zu Google Kalender hinzuf√ºgen
            </a>
            <button id="ics-download-btn" class="w-full flex items-center justify-center p-3 font-semibold rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition duration-150">
                <i data-lucide="download" class="w-5 h-5 mr-2"></i> .ics (Outlook, Apple) herunterladen
            </button>
            <p class="text-xs text-gray-500 pt-2">Meeting Link: <a href="https://${event.link}" target="_blank" class="text-google-blue underline">${event.link}</a></p>
        `;
        
        document.getElementById('ics-download-btn').onclick = () => {
            downloadIcs(event);
            modal.style.display = "none";
        };

        modal.style.display = "block";
        if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        
        // Schlie√üen-Handler, um nur das Modal zu schlie√üen
        const closeHandler = () => { modal.style.display = "none"; };
        closeModalBtn.onclick = closeHandler;
        closeModalTop.onclick = closeHandler;
        window.onclick = (event) => {
            if (event.target == modal) { modal.style.display = "none"; }
        };
    }
</script>


<script type="module">
    // *** MODUL BEGINNT ***

    const quizContainer = document.getElementById('quiz-container');
    const GOOGLE_SHEETS_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsg_ySSpTeWIjxQnjnbrvx-dKTe1OmvIkgZDqo5gN3XNiDUSiGYNwzT2pkUb6GCkqeNA/exec"; 

    // --- ZUST√ÑNDE ---
    let currentScreen = 'calendar'; // NEU: Startet mit der Kalenderansicht
    let currentQuestionIndex = 0;
    let score = 0;
    let firstName = '';
    let lastName = '';
    let quizSubmitted = false;
    let selectedEvent = null; // NEU: H√§lt das ausgew√§hlte Event
    
    const userId = crypto.randomUUID(); 
    
    // --- KALENDER DATEN (WIE VORHER) ---
    // Parse die CSV-Daten
    const csvData = `Datum,Uhrzeit,Link
09.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
09.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
10.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
10.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
13.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
13.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
14.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
14.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
15.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
15.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
16.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
16.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
17.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
17.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
20.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
20.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
21.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
21.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj
22.10.2025,09:00 Uhr,meet.google.com/knh-yitj-qaj
22.10.2025,14:00 Uhr,meet.google.com/knh-yitj-qaj`;

    const CALENDAR_EVENTS = csvData.split('\n').slice(1).map(row => {
        const [date, time, link] = row.split(',');
        return { date: date.trim(), time: time.trim(), link: link.trim() };
    });
    // --- ENDE KALENDER DATEN ---

    // Die QUESTIONS sind unver√§ndert und bleiben hier. (Linien ~383 - ~550)
    const QUESTIONS = [
        {
            id: 1,
            type: 'mc',
            question: "Welchen Prozessor verwendet das Pixel 10 Pro Fold? üß†",
            options: ["Snapdragon 8 Gen 3", "Samsung Exynos 2500", "Google Tensor G5", "Apple M2"],
            correctAnswer: "Google Tensor G5",
            emoji: "‚ú®"
        },
        {
            id: 2,
            type: 'tf',
            question: "Die Pixel Watch 4 (45 mm) bietet eine l√§ngere Akkulaufzeit als die 41 mm Version.",
            correctAnswer: true,
            emoji: "üîã"
        },
        {
            id: 3,
            type: 'mc',
            question: "Welche Speicheroption wird beim Pixel 10 Pro Fold als 'Neu' beworben?",
            options: ["256 GB", "512 GB", "1 TB", "2 TB"],
            correctAnswer: "1 TB",
            emoji: "üíæ"
        },
        {
            id: 4,
            type: 'tf',
            question: "Das Pixel 10 Pro Fold hat mit IP68 die gleiche Wasser- und Staubschutzklasse wie das Samsung Galaxy Z Fold7 (IP48).",
            correctAnswer: false, // Fold7 hat IP48, P10 Pro Fold hat IP68
            emoji: "üíß"
        },
        {
            id: 5,
            type: 'mc',
            question: "Welche Zoomstufe (Teleobjektiv) bietet das Pixel 10 Pro Fold? üî≠",
            options: ["3-fach", "3,5-fach", "4-fach", "5-fach"],
            correctAnswer: "5-fach",
            emoji: "üîç"
        },
        {
            id: 6,
            type: 'tf',
            question: "Das Display der Pixel Watch 4 ist mit 3D Corning Gorilla Glass 5 ausgestattet und kratzbest√§ndig.",
            correctAnswer: true,
            emoji: "üõ°Ô∏è"
        },
        {
            id: 7,
            type: 'mc',
            question: "Welche Funktion erm√∂glicht es, eine Vorschau des Fotos auf dem √§u√üeren Display des Pixel 10 Pro Fold zu sehen, bevor Du es aufnimmst?",
            options: ["Sofortansicht", "Blickfang", "Dual Screen-Vorschau", "Fold Kamerasystem"],
            correctAnswer: "Dual Screen-Vorschau",
            emoji: "ü§≥"
        },
        {
            id: 8,
            type: 'tf',
            question: "Die Pixel Watch 4 verf√ºgt √ºber verbesserte Multispektralsensoren der 3. Generation.",
            correctAnswer: true,
            emoji: "‚åö"
        },
        {
            id: 9,
            type: 'mc',
            question: "Wie gro√ü ist das Innendisplay des Pixel 10 Pro Fold (Diagonale)? üñ•Ô∏è",
            options: ["7,8 Zoll", "6,9 Zoll", "8,0 Zoll", "8,2 Zoll"],
            correctAnswer: "8,0 Zoll",
            emoji: "üìê"
        },
        {
            id: 10,
            type: 'tf',
            question: "Die Pixel Watch 4 l√§dt 50 % schneller und bietet 50 % l√§ngere Akkulaufzeit als die Pixel Watch 3.",
            correctAnswer: false, // Es sind 25% schneller und 25% l√§nger
            emoji: "‚ö°"
        },
        {
            id: 11,
            type: 'mc',
            question: "Welches Konkurrenzmodell bietet die h√∂chste Akkukapazit√§t von 5.150 mAh? (Vergleichsdaten Fold)",
            options: ["Galaxy Z Fold7", "Honor Magic V3", "OnePlus Open", "Pixel 10 Pro Fold"],
            correctAnswer: "Honor Magic V3",
            emoji: "ü•á"
        },
        {
            id: 12,
            type: 'tf',
            question: "Das Pixel 10 Pro Fold besitzt ein 'Neu gestaltetes Scharnier ohne Zahnrad'.",
            correctAnswer: true,
            emoji: "üõ†Ô∏è"
        },
        {
            id: 13,
            type: 'mc',
            question: "Wie lange ist das Google AI Pro Probeabo beim Kauf des Pixel 10 Pro Fold inklusive? (Gemini-Funktionen)",
            options: ["3 Monate", "6 Monate", "1 Jahr", "2 Jahre"],
            correctAnswer: "1 Jahr",
            emoji: "üí°"
        },
        {
            id: 14,
            type: 'tf',
            question: "Das Actua 360-Display der Pixel Watch 4 ist 10 % heller als das Vorg√§ngermodell.",
            correctAnswer: false, // Es ist 50% heller
            emoji: "üîÜ"
        },
        {
            id: 15,
            type: 'mc',
            question: "Welche Google-Funktion nutzt das Kamerabild in Echtzeit, um Fragen zu stellen? üí¨",
            options: ["Sofortansicht", "Gemini Live mit Kamera", "Live-√úbersetzung", "Google Lens"],
            correctAnswer: "Gemini Live mit Kamera",
            emoji: "üé§"
        },
        {
            id: 16,
            type: 'tf',
            question: "Mit der 'Splitscreen'-Funktion kannst Du Inhalte per Drag-and-drop zwischen kompatiblen Apps auf dem Pixel 10 Pro Fold verschieben.",
            correctAnswer: true,
            emoji: "üß©"
        },
        {
            id: 17,
            type: 'mc',
            question: "Die Videogenerierung in Gemini wird beim Pixel 10 Pro Fold durch welche Technologie unterst√ºtzt? üé•",
            options: ["Gemini 4", "Imagen 3", "Veo 3", "DeepMind"],
            correctAnswer: "Veo 3",
            emoji: "üé¨"
        },
        {
            id: 18,
            type: 'tf',
            question: "Die Pixel Watch 4 unterst√ºtzt genaues GPS-Tracking im Gel√§nde durch Zweifrequenz-GPS.",
            correctAnswer: true,
            emoji: "üìç"
        },
        {
            id: 19,
            type: 'mc',
            question: "Welcher Fold-Konkurrent bietet eine 3-fach-Teleobjektiv-Kamera mit 64 MP? (Vergleichsdaten)",
            options: ["Galaxy Z Fold7", "Honor Magic V3", "OnePlus Open", "Xiaomi Mix Fold 4"],
            correctAnswer: "OnePlus Open",
            emoji: "üì∏"
        },
        {
            id: 20,
            type: 'tf',
            question: "Die Pixel Watch 4 (45 mm) erreicht eine Akkulaufzeit von bis zu 40 Stunden.",
            correctAnswer: true,
            emoji: "‚è≥"
        }
    ];

    /**
     * Macht die Zustandsverwaltung im Modul f√ºr globale Funktionen zug√§nglich (f√ºr openCalendarModal).
     */
    window.quizApp = {
        selectEventAndProceed: (event) => {
            selectedEvent = event;
            currentScreen = 'start'; // Wechsel zur Namenseingabe
            render();
        }
    };


    /**
     * Speichert die Ergebnisse ausschlie√ülich an Google Sheets.
     */
    async function saveResult() {
        if (quizSubmitted) return;

        // Erstellt das Datenobjekt f√ºr das Google Apps Script
        const resultData = {
            userId: userId,
            firstName: firstName,
            lastName: lastName,
            score: score,
            totalQuestions: QUESTIONS.length,
            selectedEventDate: selectedEvent ? selectedEvent.date : 'N/A', // Speichert den gebuchten Termin
            selectedEventTime: selectedEvent ? selectedEvent.time : 'N/A', 
            timestamp: new Date()
        };

        // 1. An Google Sheets (Apps Script) senden
        if (GOOGLE_SHEETS_APPS_SCRIPT_URL.startsWith("https://")) {
            try {
                const response = await fetch(GOOGLE_SHEETS_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify(resultData),
                });
                quizSubmitted = true; 

                const result = await response.json();
                if (result.status === 'success') {
                    console.log("Daten erfolgreich an Google Sheet gesendet!");
                } else {
                    console.error("Fehler beim Senden an Google Sheet:", result.message);
                }
            } catch (error) {
                console.error("Netzwerkfehler beim Senden an Google Sheet:", error);
            }
        } else {
             console.warn("Apps Script URL fehlt oder ist fehlerhaft.");
        }

        // Aktualisiert den Bildschirm, um den Erfolg anzuzeigen
        render();
    }

    // --- RENDERING FUNKTIONEN ---

    /**
     * NEU: Rendert den ersten Bildschirm zur Terminauswahl.
     */
    function renderCalendarSelectionScreen() {
        let calendarHtml = CALENDAR_EVENTS.map(event => {
            // Extrahiere Tag und Monat f√ºr gr√∂√üere Darstellung
            const [day, month, year] = event.date.split('.');
            const formattedDay = parseInt(day); // Keine f√ºhrende Null
            const monthNames = ["Jan", "Feb", "M√§r", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"];
            const formattedMonth = monthNames[parseInt(month) - 1];

            return `
                <button data-date="${event.date}" data-time="${event.time}" 
                        class="w-full text-left p-3 mb-3 border border-google-blue/30 bg-white rounded-lg hover:bg-google-blue/10 transition duration-150 flex items-center justify-between calendar-button-3d"
                        onclick="openCalendarModal({date: '${event.date}', time: '${event.time}', link: '${event.link}'})">
                    <div class="flex flex-col items-center justify-center p-2 mr-4 bg-google-blue/10 rounded-md">
                        <span class="text-2xl font-bold text-google-blue leading-none">${formattedDay}</span>
                        <span class="text-xs font-semibold text-gray-600">${formattedMonth}</span>
                    </div>
                    <div class="flex-grow">
                        <span class="font-semibold text-gray-800">${event.date}</span>
                    </div>
                    <span class="font-mono text-google-blue flex items-center text-sm">
                        <i data-lucide="clock" class="w-4 h-4 mr-1"></i> ${event.time} 
                    </span>
                </button>
            `;
        }).join('');

        quizContainer.innerHTML = `
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Terminbuchung</h2>
            <p class="mb-6 text-gray-600">Bitte w√§hle zuerst Deinen gew√ºnschten Trainingstermin aus. Nach der Auswahl gelangst Du direkt zum Quiz.</p>
            
            <div class="mt-4">
                <h3 class="text-xl font-bold mb-4 text-google-blue flex items-center">
                    <i data-lucide="calendar" class="w-5 h-5 mr-2"></i> W√§hle Dein Training
                </h3>
                <div class="max-h-80 overflow-y-auto pr-2 custom-scrollbar">
                    ${calendarHtml}
                </div>
            </div>
        `;
        if (typeof lucide !== 'undefined') { lucide.createIcons(); }
    }


    /**
     * Rendert den Namenseingabebildschirm (Nach der Terminauswahl).
     */
    function renderNameInputScreen() {
        const selectedDateText = selectedEvent 
            ? `Dein Termin am **${selectedEvent.date} um ${selectedEvent.time}** ist vorgemerkt.`
            : `Bitte gib Deinen Namen ein, um das Quiz zu starten (Pflichtfelder).`;

        quizContainer.innerHTML = `
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Willkommen</h2>
            <p class="mb-6 text-google-blue font-semibold text-center p-3 border border-google-blue/30 rounded-lg">
                <i data-lucide="check" class="w-4 h-4 inline-block mr-1"></i> ${selectedDateText}
            </p>

            <form id="start-form">
                <div class="mb-4">
                    <label for="first-name" class="block text-sm font-medium text-gray-700 mb-1">Vorname *</label>
                    <input type="text" id="first-name" name="first-name" value="${firstName}" placeholder="Dein Vorname" required
                        class="w-full p-3 border border-pixel-gray rounded-lg focus:ring-google-blue focus:border-google-blue transition duration-150">
                </div>
                <div class="mb-6">
                    <label for="last-name" class="block text-sm font-medium text-gray-700 mb-1">Nachname *</label>
                    <input type="text" id="last-name" name="last-name" value="${lastName}" placeholder="Dein Nachname" required
                        class="w-full p-3 border border-pixel-gray rounded-lg focus:ring-google-blue focus:border-google-blue transition duration-150">
                </div>
                <button type="submit"
                    class="w-full bg-google-blue text-white p-4 rounded-lg font-bold text-lg hover:bg-opacity-90 transition duration-150 flex items-center justify-center">
                    Quiz starten <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                </button>
            </form>
        `;

        // Event Listener f√ºr das Formular hinzuf√ºgen
        const form = document.getElementById('start-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            firstName = document.getElementById('first-name').value.trim();
            lastName = document.getElementById('last-name').value.trim();
            if (firstName && lastName) {
                currentScreen = 'quiz';
                render();
            } else {
                alert("Bitte f√ºlle beide Namensfelder aus.");
            }
        });
        if (typeof lucide !== 'undefined') { lucide.createIcons(); }
    }


    /**
     * Rendert die aktuelle Frage.
     */
    function renderQuestionScreen() {
        const question = QUESTIONS[currentQuestionIndex];
        let optionsHtml = '';

        if (question.type === 'mc') {
            optionsHtml = question.options.map(option => `
                <button class="answer-btn w-full text-left p-4 border border-pixel-gray rounded-lg hover:bg-pixel-gray transition duration-150" data-answer="${option}">
                    ${option}
                </button>
            `).join('');
        } else if (question.type === 'tf') {
            optionsHtml = `
                <button class="answer-btn w-full text-left p-4 border border-pixel-gray rounded-lg hover:bg-pixel-gray transition duration-150" data-answer="true">
                    Wahr
                </button>
                <button class="answer-btn w-full text-left p-4 border border-pixel-gray rounded-lg hover:bg-pixel-gray transition duration-150" data-answer="false">
                    Falsch
                </button>
            `;
        }

        quizContainer.innerHTML = `
            <div class="mb-4 text-sm text-gray-500">
                Frage ${currentQuestionIndex + 1} von ${QUESTIONS.length}
            </div>
            <p class="text-xl font-semibold mb-6">${question.emoji} ${question.question}</p>
            <div class="space-y-3">
                ${optionsHtml}
            </div>
        `;

        // Event Listeners f√ºr die Antwort-Buttons
        document.querySelectorAll('.answer-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const selectedAnswer = e.target.dataset.answer;
                
                // Konvertiere 'true'/'false' String zu Boolean f√ºr den Vergleich
                let correctAnswer = question.correctAnswer;
                let answerToCheck = selectedAnswer;
                if (typeof correctAnswer === 'boolean') {
                    answerToCheck = (selectedAnswer === 'true');
                }
                
                if (answerToCheck === correctAnswer) {
                    score++;
                }

                if (currentQuestionIndex < QUESTIONS.length - 1) {
                    currentQuestionIndex++;
                    render();
                } else {
                    currentScreen = 'result';
                    saveResult(); // Ergebnis speichern
                    render();
                }
            });
        });
    }

    /**
     * Rendert den Ergebnisbildschirm.
     */
    function renderResultScreen() {
        const percentage = Math.round((score / QUESTIONS.length) * 100);
        let resultMessage = '';
        let emoji = '';

        if (percentage >= 80) {
            resultMessage = "Perfekt! Du bist ein echter Pixel-Experte!";
            emoji = 'üèÜ';
        } else if (percentage >= 50) {
            resultMessage = "Stark! Du kennst dich gut aus!";
            emoji = 'üëç';
        } else {
            resultMessage = "Da ist noch Luft nach oben. Schau dir das Training gut an!";
            emoji = 'üí™';
        }
        
        const eventInfo = selectedEvent 
            ? `<p class="mt-4 text-center p-3 bg-google-blue/10 text-google-blue font-semibold rounded-lg">
                   Dein Training findet am <strong>${selectedEvent.date}</strong> um <strong>${selectedEvent.time}</strong> statt.
                   <br>Link: <a href="https://${selectedEvent.link}" target="_blank" class="underline">${selectedEvent.link}</a>
               </p>`
            : '';

        quizContainer.innerHTML = `
            <h2 class="text-2xl font-bold mb-4 text-center">${emoji} Quiz beendet, ${firstName}!</h2>
            <p class="text-center text-lg mb-6">Du hast <strong>${score} von ${QUESTIONS.length}</strong> Fragen richtig beantwortet.</p>
            <div class="text-center p-6 bg-pixel-gray rounded-lg mb-6">
                <div class="text-5xl font-extrabold text-google-blue">${percentage}%</div>
                <p class="mt-2 text-gray-700">${resultMessage}</p>
            </div>
            ${eventInfo}
            <p class="text-xs text-center text-gray-500 mt-6">
                Dein Ergebnis wurde gespeichert. Du kannst diese Seite nun schlie√üen.
            </p>
        `;
    }

    // --- Haupt-Render-Funktion ---
    function render() {
        quizContainer.innerHTML = ''; // Leert den Container vor dem Neuzeichnen
        switch (currentScreen) {
            case 'calendar':
                renderCalendarSelectionScreen();
                break;
            case 'start':
                renderNameInputScreen();
                break;
            case 'quiz':
                renderQuestionScreen();
                break;
            case 'result':
                renderResultScreen();
                break;
            default:
                quizContainer.innerHTML = '<p>Ein Fehler ist aufgetreten.</p>';
        }
    }

    // Initiales Rendern beim Laden der Seite
    document.addEventListener('DOMContentLoaded', () => {
        render();
    });

</script>

</body>
</html>
